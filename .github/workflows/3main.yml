name: Setup Remote Desktop & SSH Tunnel

on:
  workflow_dispatch:

jobs:
  setup:
    runs-on: windows-latest
    steps:
      - name: Enable Terminal Services
        run: Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0

      - name: Enable Remote Desktop in Firewall
        run: Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

      - name: Enable RDP User Authentication
        run: Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -Value 1

      - name: Set User Password
        run: |
          $password = ConvertTo-SecureString -AsPlainText "P@ssw0rd!" -Force
          Set-LocalUser -Name "runneradmin" -Password $password

      - name: Prevent System Sleep
        run: powercfg /change standby-timeout-ac 0

      - name: Create .ssh directory
        run: |
          New-Item -ItemType Directory -Force -Path "$env:USERPROFILE\.ssh"

      - name: Save SSH private key
        shell: pwsh
        run: |
          # Retrieve the private key from GitHub secrets and save it as mrabdellahshop.first.pem
          $privateKey = "${{ secrets.SSH_PRIVATE_KEY }}"
          $privateKey | Out-File -FilePath "$env:USERPROFILE\.ssh\mrabdellahshop.first.pem" -Encoding ascii
          # Remove inherited permissions and grant access only to the current user
          icacls "$env:USERPROFILE\.ssh\mrabdellahshop.first.pem" /inheritance:r
          icacls "$env:USERPROFILE\.ssh\mrabdellahshop.first.pem" /grant:r "$($env:USERNAME):(R,W)"

      - name: Start Reverse SSH Tunnel
        shell: pwsh
        run: |
          ssh -i "$env:USERPROFILE\.ssh\mrabdellahshop.first.pem" mrabdellahshop.first@mrabdellahshop-58804.portmap.host -N -R 58804:localhost:3389
